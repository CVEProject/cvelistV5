{
    "dataType": "CVE_RECORD",
    "dataVersion": "5.2",
    "cveMetadata": {
        "cveId": "CVE-2023-54180",
        "assignerOrgId": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
        "state": "PUBLISHED",
        "assignerShortName": "Linux",
        "dateReserved": "2025-12-30T12:06:44.497Z",
        "datePublished": "2025-12-30T12:08:51.727Z",
        "dateUpdated": "2025-12-30T12:08:51.727Z"
    },
    "containers": {
        "cna": {
            "providerMetadata": {
                "orgId": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
                "shortName": "Linux",
                "dateUpdated": "2025-12-30T12:08:51.727Z"
            },
            "descriptions": [
                {
                    "lang": "en",
                    "value": "In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: handle case when repair happens with dev-replace\n\n[BUG]\nThere is a bug report that a BUG_ON() in btrfs_repair_io_failure()\n(originally repair_io_failure() in v6.0 kernel) got triggered when\nreplacing a unreliable disk:\n\n  BTRFS warning (device sda1): csum failed root 257 ino 2397453 off 39624704 csum 0xb0d18c75 expected csum 0x4dae9c5e mirror 3\n  kernel BUG at fs/btrfs/extent_io.c:2380!\n  invalid opcode: 0000 [#1] PREEMPT SMP NOPTI\n  CPU: 9 PID: 3614331 Comm: kworker/u257:2 Tainted: G           OE      6.0.0-5-amd64 #1  Debian 6.0.10-2\n  Hardware name: Micro-Star International Co., Ltd. MS-7C60/TRX40 PRO WIFI (MS-7C60), BIOS 2.70 07/01/2021\n  Workqueue: btrfs-endio btrfs_end_bio_work [btrfs]\n  RIP: 0010:repair_io_failure+0x24a/0x260 [btrfs]\n  Call Trace:\n   <TASK>\n   clean_io_failure+0x14d/0x180 [btrfs]\n   end_bio_extent_readpage+0x412/0x6e0 [btrfs]\n   ? __switch_to+0x106/0x420\n   process_one_work+0x1c7/0x380\n   worker_thread+0x4d/0x380\n   ? rescuer_thread+0x3a0/0x3a0\n   kthread+0xe9/0x110\n   ? kthread_complete_and_exit+0x20/0x20\n   ret_from_fork+0x22/0x30\n\n[CAUSE]\n\nBefore the BUG_ON(), we got some read errors from the replace target\nfirst, note the mirror number (3, which is beyond RAID1 duplication,\nthus it's read from the replace target device).\n\nThen at the BUG_ON() location, we are trying to writeback the repaired\nsectors back the failed device.\n\nThe check looks like this:\n\n\t\tret = btrfs_map_block(fs_info, BTRFS_MAP_WRITE, logical,\n\t\t\t\t      &map_length, &bioc, mirror_num);\n\t\tif (ret)\n\t\t\tgoto out_counter_dec;\n\t\tBUG_ON(mirror_num != bioc->mirror_num);\n\nBut inside btrfs_map_block(), we can modify bioc->mirror_num especially\nfor dev-replace:\n\n\tif (dev_replace_is_ongoing && mirror_num == map->num_stripes + 1 &&\n\t    !need_full_stripe(op) && dev_replace->tgtdev != NULL) {\n\t\tret = get_extra_mirror_from_replace(fs_info, logical, *length,\n\t\t\t\t\t\t    dev_replace->srcdev->devid,\n\t\t\t\t\t\t    &mirror_num,\n\t\t\t\t\t    &physical_to_patch_in_first_stripe);\n\t\tpatch_the_first_stripe_for_dev_replace = 1;\n\t}\n\nThus if we're repairing the replace target device, we're going to\ntrigger that BUG_ON().\n\nBut in reality, the read failure from the replace target device may be\nthat, our replace hasn't reached the range we're reading, thus we're\nreading garbage, but with replace running, the range would be properly\nfilled later.\n\nThus in that case, we don't need to do anything but let the replace\nroutine to handle it.\n\n[FIX]\nInstead of a BUG_ON(), just skip the repair if we're repairing the\ndevice replace target device."
                }
            ],
            "affected": [
                {
                    "product": "Linux",
                    "vendor": "Linux",
                    "defaultStatus": "unaffected",
                    "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
                    "programFiles": [
                        "fs/btrfs/bio.c"
                    ],
                    "versions": [
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "a7018b40b49c37fb55736499f790ec0d2b381ae4",
                            "status": "affected",
                            "versionType": "git"
                        },
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "53e9d6851b56626885476a2966194ba994f8bb4b",
                            "status": "affected",
                            "versionType": "git"
                        },
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "d73a27b86fc722c28a26ec64002e3a7dc86d1c07",
                            "status": "affected",
                            "versionType": "git"
                        }
                    ]
                },
                {
                    "product": "Linux",
                    "vendor": "Linux",
                    "defaultStatus": "affected",
                    "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
                    "programFiles": [
                        "fs/btrfs/bio.c"
                    ],
                    "versions": [
                        {
                            "version": "6.0.19",
                            "lessThanOrEqual": "6.0.*",
                            "status": "unaffected",
                            "versionType": "semver"
                        },
                        {
                            "version": "6.1.5",
                            "lessThanOrEqual": "6.1.*",
                            "status": "unaffected",
                            "versionType": "semver"
                        },
                        {
                            "version": "6.2",
                            "lessThanOrEqual": "*",
                            "status": "unaffected",
                            "versionType": "original_commit_for_fix"
                        }
                    ]
                }
            ],
            "cpeApplicability": [
                {
                    "nodes": [
                        {
                            "operator": "OR",
                            "negate": false,
                            "cpeMatch": [
                                {
                                    "vulnerable": true,
                                    "criteria": "cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*",
                                    "versionEndExcluding": "6.0.19"
                                },
                                {
                                    "vulnerable": true,
                                    "criteria": "cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*",
                                    "versionEndExcluding": "6.1.5"
                                },
                                {
                                    "vulnerable": true,
                                    "criteria": "cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*",
                                    "versionEndExcluding": "6.2"
                                }
                            ]
                        }
                    ]
                }
            ],
            "references": [
                {
                    "url": "https://git.kernel.org/stable/c/a7018b40b49c37fb55736499f790ec0d2b381ae4"
                },
                {
                    "url": "https://git.kernel.org/stable/c/53e9d6851b56626885476a2966194ba994f8bb4b"
                },
                {
                    "url": "https://git.kernel.org/stable/c/d73a27b86fc722c28a26ec64002e3a7dc86d1c07"
                }
            ],
            "title": "btrfs: handle case when repair happens with dev-replace",
            "x_generator": {
                "engine": "bippy-1.2.0"
            }
        }
    }
}