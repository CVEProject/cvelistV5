{
    "dataType": "CVE_RECORD",
    "dataVersion": "5.1",
    "cveMetadata": {
        "cveId": "CVE-2022-49159",
        "assignerOrgId": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
        "state": "PUBLISHED",
        "assignerShortName": "Linux",
        "dateReserved": "2025-02-26T01:49:39.276Z",
        "datePublished": "2025-02-26T01:55:22.021Z",
        "dateUpdated": "2025-02-26T01:55:22.021Z"
    },
    "containers": {
        "cna": {
            "providerMetadata": {
                "orgId": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
                "shortName": "Linux",
                "dateUpdated": "2025-02-26T01:55:22.021Z"
            },
            "descriptions": [
                {
                    "lang": "en",
                    "value": "In the Linux kernel, the following vulnerability has been resolved:\n\nscsi: qla2xxx: Implement ref count for SRB\n\nThe timeout handler and the done function are racing. When\nqla2x00_async_iocb_timeout() starts to run it can be preempted by the\nnormal response path (via the firmware?). qla24xx_async_gpsc_sp_done()\nreleases the SRB unconditionally. When scheduling back to\nqla2x00_async_iocb_timeout() qla24xx_async_abort_cmd() will access an freed\nsp->qpair pointer:\n\n  qla2xxx [0000:83:00.0]-2871:0: Async-gpsc timeout - hdl=63d portid=234500 50:06:0e:80:08:77:b6:21.\n  qla2xxx [0000:83:00.0]-2853:0: Async done-gpsc res 0, WWPN 50:06:0e:80:08:77:b6:21\n  qla2xxx [0000:83:00.0]-2854:0: Async-gpsc OUT WWPN 20:45:00:27:f8:75:33:00 speeds=2c00 speed=0400.\n  qla2xxx [0000:83:00.0]-28d8:0: qla24xx_handle_gpsc_event 50:06:0e:80:08:77:b6:21 DS 7 LS 6 rc 0 login 1|1 rscn 1|0 lid 5\n  BUG: unable to handle kernel NULL pointer dereference at 0000000000000004\n  IP: qla24xx_async_abort_cmd+0x1b/0x1c0 [qla2xxx]\n\nObvious solution to this is to introduce a reference counter. One reference\nis taken for the normal code path (the 'good' case) and one for the timeout\npath. As we always race between the normal good case and the timeout/abort\nhandler we need to serialize it. Also we cannot assume any order between\nthe handlers. Since this is slow path we can use proper synchronization via\nlocks.\n\nWhen we are able to cancel a timer (del_timer returns 1) we know there\ncan't be any error handling in progress because the timeout handler hasn't\nexpired yet, thus we can safely decrement the refcounter by one.\n\nIf we are not able to cancel the timer, we know an abort handler is\nrunning. We have to make sure we call sp->done() in the abort handlers\nbefore calling kref_put()."
                }
            ],
            "affected": [
                {
                    "product": "Linux",
                    "vendor": "Linux",
                    "defaultStatus": "unaffected",
                    "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
                    "programFiles": [
                        "drivers/scsi/qla2xxx/qla_bsg.c",
                        "drivers/scsi/qla2xxx/qla_def.h",
                        "drivers/scsi/qla2xxx/qla_edif.c",
                        "drivers/scsi/qla2xxx/qla_gbl.h",
                        "drivers/scsi/qla2xxx/qla_gs.c",
                        "drivers/scsi/qla2xxx/qla_init.c",
                        "drivers/scsi/qla2xxx/qla_inline.h",
                        "drivers/scsi/qla2xxx/qla_iocb.c",
                        "drivers/scsi/qla2xxx/qla_mbx.c",
                        "drivers/scsi/qla2xxx/qla_mid.c",
                        "drivers/scsi/qla2xxx/qla_mr.c",
                        "drivers/scsi/qla2xxx/qla_os.c",
                        "drivers/scsi/qla2xxx/qla_target.c"
                    ],
                    "versions": [
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "e17111dd2fda81c35f309b1e5b6ab35809a375e7",
                            "status": "affected",
                            "versionType": "git"
                        },
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "e140723f78ff418c8df7d990e102e07b65c87d4a",
                            "status": "affected",
                            "versionType": "git"
                        },
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "ceda7f794f3dfe272491e93e3e93049f8be5f07b",
                            "status": "affected",
                            "versionType": "git"
                        },
                        {
                            "version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2",
                            "lessThan": "31e6cdbe0eae37badceb5e0d4f06cf051432fd77",
                            "status": "affected",
                            "versionType": "git"
                        }
                    ]
                },
                {
                    "product": "Linux",
                    "vendor": "Linux",
                    "defaultStatus": "affected",
                    "repo": "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git",
                    "programFiles": [
                        "drivers/scsi/qla2xxx/qla_bsg.c",
                        "drivers/scsi/qla2xxx/qla_def.h",
                        "drivers/scsi/qla2xxx/qla_edif.c",
                        "drivers/scsi/qla2xxx/qla_gbl.h",
                        "drivers/scsi/qla2xxx/qla_gs.c",
                        "drivers/scsi/qla2xxx/qla_init.c",
                        "drivers/scsi/qla2xxx/qla_inline.h",
                        "drivers/scsi/qla2xxx/qla_iocb.c",
                        "drivers/scsi/qla2xxx/qla_mbx.c",
                        "drivers/scsi/qla2xxx/qla_mid.c",
                        "drivers/scsi/qla2xxx/qla_mr.c",
                        "drivers/scsi/qla2xxx/qla_os.c",
                        "drivers/scsi/qla2xxx/qla_target.c"
                    ],
                    "versions": [
                        {
                            "version": "5.15.33",
                            "lessThanOrEqual": "5.15.*",
                            "status": "unaffected",
                            "versionType": "semver"
                        },
                        {
                            "version": "5.16.19",
                            "lessThanOrEqual": "5.16.*",
                            "status": "unaffected",
                            "versionType": "semver"
                        },
                        {
                            "version": "5.17.2",
                            "lessThanOrEqual": "5.17.*",
                            "status": "unaffected",
                            "versionType": "semver"
                        },
                        {
                            "version": "5.18",
                            "lessThanOrEqual": "*",
                            "status": "unaffected",
                            "versionType": "original_commit_for_fix"
                        }
                    ]
                }
            ],
            "references": [
                {
                    "url": "https://git.kernel.org/stable/c/e17111dd2fda81c35f309b1e5b6ab35809a375e7"
                },
                {
                    "url": "https://git.kernel.org/stable/c/e140723f78ff418c8df7d990e102e07b65c87d4a"
                },
                {
                    "url": "https://git.kernel.org/stable/c/ceda7f794f3dfe272491e93e3e93049f8be5f07b"
                },
                {
                    "url": "https://git.kernel.org/stable/c/31e6cdbe0eae37badceb5e0d4f06cf051432fd77"
                }
            ],
            "title": "scsi: qla2xxx: Implement ref count for SRB",
            "x_generator": {
                "engine": "bippy-5f407fcff5a0"
            }
        }
    }
}